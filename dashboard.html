<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seat Dashboard</title>

<script type="module">
import { db } from "./firebase.js";
import { doc, getDoc, setDoc } from 
"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const grid = document.getElementById("seatGrid");
const modal = document.getElementById("modal");

let currentSeat = null;
let currentSlots = [];

function createSeats() {
  for (let i = 1; i <= 142; i++) {
    const card = document.createElement("div");
    card.className = "seat-card";
    card.innerHTML = `
      <div class="seat-number">Seat ${i}</div>
      <div class="dots">
        <div class="dot green" onclick="openForm(${i}, 's1')"></div>
        <div class="dot green" onclick="openForm(${i}, 's2')"></div>
        <div class="dot green" onclick="openForm(${i}, 's3')"></div>
        <div class="dot green" onclick="openForm(${i}, 's4')"></div>
      </div>
    `;
    grid.appendChild(card);
  }
}

window.openForm = function(seatId, slot) {
  currentSeat = seatId;

  const plan = document.getElementById("planSelect").value;

  if (plan === "s1s2") currentSlots = ["s1","s2"];
  else if (plan === "s3s4") currentSlots = ["s3","s4"];
  else if (plan === "all") currentSlots = ["s1","s2","s3","s4"];
  else currentSlots = [slot];

  modal.style.display = "flex";
};

window.closeModal = function() {
  modal.style.display = "none";
};

window.clearForm = function() {
  document.getElementById("name").value = "";
  document.getElementById("mobile").value = "";
  document.getElementById("email").value = "";
  document.getElementById("idNumber").value = "";
  document.getElementById("validTill").value = "";
};

window.saveBooking = async function() {

  const nameVal = document.getElementById("name").value.trim();
  const mobileVal = document.getElementById("mobile").value.trim();
  const emailVal = document.getElementById("email").value.trim();
  const idVal = document.getElementById("idNumber").value.trim();
  const validTillVal = document.getElementById("validTill").value;

  if (!nameVal || !mobileVal || !validTillVal) {
    alert("Name, Mobile and Valid Till date are required.");
    return;
  }

  const seatRef = doc(db, "seats", "seat_" + currentSeat);
  const snap = await getDoc(seatRef);

  let data = snap.exists() ? snap.data() : {};

  const today = new Date().toISOString().split("T")[0];

  const booking = {
    name: nameVal,
    mobile: mobileVal,
    email: emailVal,
    idNumber: idVal,
    plan: document.getElementById("planSelect").value,
    createdAt: today,
    validTill: validTillVal
  };

  for (let s of currentSlots) {
    data[s] = booking;
  }

  await setDoc(seatRef, data);

  closeModal();
  clearForm();

  alert("Booking saved successfully.");
};

createSeats();
</script>
</head>

<body>

<div class="top-bar">
<select id="planSelect">
  <option value="s1">6-10 AM (399)</option>
  <option value="s2">10-2 PM (399)</option>
  <option value="s3">2-6 PM (399)</option>
  <option value="s4">6-10 PM (399)</option>
  <option value="s1s2">6AM-2PM (799)</option>
  <option value="s3s4">2PM-10PM (799)</option>
  <option value="all">6AM-10PM (1199)</option>
</select>
</div>

<div class="seat-grid" id="seatGrid"></div>

<div class="modal" id="modal">
  <div class="modal-content">
  <h3>Member Details</h3>
  <input type="text" id="name" placeholder="Name">
  <input type="text" id="mobile" placeholder="Mobile">
  <input type="email" id="email" placeholder="Email">
  <input type="text" id="idNumber" placeholder="Aadhar / PAN">
  <input type="date" id="validTill">

  <button onclick="saveBooking()">Save</button>
  <button style="margin-top:8px;background:#999;" onclick="clearForm()">Clear</button>
  <button style="margin-top:8px;background:#e74c3c;" onclick="closeModal()">Close</button>
</div>
</div>

<script type="module">
import { db } from "./firebase.js";
import { doc, getDoc, setDoc } from 
"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const grid = document.getElementById("seatGrid");
const modal = document.getElementById("modal");

let currentSeat = null;
let currentSlots = [];

function createSeats() {
  for (let i = 1; i <= 142; i++) {
    const card = document.createElement("div");
    card.className = "seat-card";
    card.innerHTML = `
      <div class="seat-number">Seat ${i}</div>
      <div class="dots">
        <div class="dot green" onclick="openForm(${i}, 's1')"></div>
        <div class="dot green" onclick="openForm(${i}, 's2')"></div>
        <div class="dot green" onclick="openForm(${i}, 's3')"></div>
        <div class="dot green" onclick="openForm(${i}, 's4')"></div>
      </div>
    `;
    grid.appendChild(card);
  }
}

window.openForm = function(seatId, slot) {
  currentSeat = seatId;

  const plan = document.getElementById("planSelect").value;

  if (plan === "s1s2") currentSlots = ["s1","s2"];
  else if (plan === "s3s4") currentSlots = ["s3","s4"];
  else if (plan === "all") currentSlots = ["s1","s2","s3","s4"];
  else currentSlots = [slot];

  modal.style.display = "flex";
}

window.saveBooking = async function() {
  const seatRef = doc(db, "seats", "seat_" + currentSeat);
  const snap = await getDoc(seatRef);

  let data = snap.exists() ? snap.data() : {};

  const today = new Date().toISOString().split("T")[0];

  const booking = {
    name: name.value,
    mobile: mobile.value,
    email: email.value,
    idNumber: idNumber.value,
    plan: document.getElementById("planSelect").value,
    createdAt: today,
    validTill: validTill.value
  };

  for (let s of currentSlots) {
    data[s] = booking;
  }

  await setDoc(seatRef, data);

  modal.style.display = "none";
  location.reload();
};

createSeats();
</script>

</body>
</html>

