<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Library Seat Dashboard</title>

<style>
* { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }

body {
  margin: 0;
  background: #eef2f7;
  padding: 15px;
}

/* Loader */
#loader {
  position: fixed;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  background: white;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  z-index: 9999;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.spinner {
  width: 50px;
  height: 50px;
  border: 6px solid #eee;
  border-top: 6px solid #2a5298;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.top-bar {
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  gap:10px;
  margin-bottom:20px;
}

.seat-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
  gap: 15px;
}

.seat-card {
  background: white;
  padding: 15px;
  border-radius: 14px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.08);
  text-align: center;
  transition: 0.2s;
}

.disabled-seat {
  background: #fdecea;
  pointer-events: none;
  opacity: 0.7;
}

.seat-number {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 10px;
}

.dots {
  display:flex;
  justify-content:center;
  gap:8px;
}

.dot {
  width:16px;
  height:16px;
  border-radius:50%;
  cursor:pointer;
}

.green { background:#2ecc71; }
.grey { background:#7f8c8d; }
.orange { background:#f39c12; }

/* Modal */
.modal {
  position: fixed;
  top:0; left:0;
  width:100%;
  height:100%;
  background: rgba(0,0,0,0.4);
  display:none;
  justify-content:center;
  align-items:center;
  padding:15px;
}

.modal-content {
  background:white;
  padding:20px;
  border-radius:12px;
  width:100%;
  max-width:400px;
}

.modal-content input {
  width:100%;
  padding:9px;
  margin-bottom:10px;
  border-radius:6px;
  border:1px solid #ccc;
}

  .availability-badge {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 14px;
  border-radius: 20px;
  background: #e8f8f1;
  border: 1px solid #2ecc71;
  font-weight: 600;
}

.availability-badge .label {
  color: #2c3e50;
  font-size: 14px;
}

.availability-badge .value {
  background: #2ecc71;
  color: white;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 14px;
}

.modal-content button {
  width:100%;
  padding:10px;
  border:none;
  border-radius:8px;
  margin-top:6px;
  cursor:pointer;
}

.save-btn { background:#2a5298; color:white; }
.clear-btn { background:#999; color:white; }
.close-btn { background:#e74c3c; color:white; }

button {
  padding:10px 14px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}

.export-btn { background:#27ae60; color:white; }
.logout-btn { background:#e74c3c; color:white; }
.counter-box { background:#2ecc71; color:white; font-weight:600; }

</style>
</head>
<body>

<div id="loader">
  <div class="spinner"></div>
  <p>Loading seat data...</p>
</div>

<div class="top-bar">
  <div style="display:flex;gap:10px;flex-wrap:wrap;">
    <select id="planSelect">
      <option value="s1">6-10 AM (₹399)</option>
      <option value="s2">10-2 PM (₹399)</option>
      <option value="s3">2-6 PM (₹399)</option>
      <option value="s4">6-10 PM (₹399)</option>
      <option value="s1s2">6AM-2PM (₹799)</option>
      <option value="s3s4">2PM-10PM (₹799)</option>
      <option value="all">6AM-10PM (₹1199)</option>
    </select>

    <button id="exportBtn" class="export-btn">Export</button>
    <div id="availableCount" class="availability-badge">
    <span class="label">Available</span>
    <span class="value">0</span>
</div>
  </div>

  <button id="logoutBtn" class="logout-btn">Logout</button>
</div>

<div class="seat-grid" id="seatGrid"></div>

<div class="modal" id="modal">
  <div class="modal-content">
    <h3>Member Details</h3>
    <input type="text" id="name" placeholder="Name">
    <input type="text" id="mobile" placeholder="Mobile">
    <input type="email" id="email" placeholder="Email">
    <input type="text" id="idNumber" placeholder="Aadhar / PAN">
    <label style="font-size:13px;">Valid Till Date</label>
    <input type="date" id="validTill">
    <button class="save-btn" id="saveBtn">Save</button>
    <button class="clear-btn" id="clearBtn">Clear</button>
    <button class="close-btn" id="closeBtn">Close</button>
  </div>
</div>

<script type="module">

import { db } from "./firebase.js";
import { collection, getDocs, doc, setDoc } from 
"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const auth = getAuth();
let seatDataCache = {};
let currentSeat = null;
let currentSlots = [];

onAuthStateChanged(auth, user => {
  if (!user) window.location.href = "index.html";
});

function showLoader(){ document.getElementById("loader").style.display="flex"; }
function hideLoader(){ document.getElementById("loader").style.display="none"; }

async function loadAllSeats(){
  const snapshot = await getDocs(collection(db,"seats"));
  seatDataCache = {};
  snapshot.forEach(docSnap=>{
    seatDataCache[docSnap.id] = docSnap.data();
  });
}

function createSeats(){
  const grid = document.getElementById("seatGrid");
  for(let i=1;i<=142;i++){
    const card=document.createElement("div");
    card.className="seat-card";
    card.innerHTML=`
      <div class="seat-number">${i}</div>
      <div class="dots">
        <div class="dot green" data-seat="${i}" data-slot="s1"></div>
        <div class="dot green" data-seat="${i}" data-slot="s2"></div>
        <div class="dot green" data-seat="${i}" data-slot="s3"></div>
        <div class="dot green" data-seat="${i}" data-slot="s4"></div>
      </div>
    `;
    grid.appendChild(card);
  }
}

function getRequiredSlots(){
  const plan=document.getElementById("planSelect").value;
  if(plan==="s1") return ["s1"];
  if(plan==="s2") return ["s2"];
  if(plan==="s3") return ["s3"];
  if(plan==="s4") return ["s4"];
  if(plan==="s1s2") return ["s1","s2"];
  if(plan==="s3s4") return ["s3","s4"];
  return ["s1","s2","s3","s4"];
}

function updateDashboard(){
  const today=new Date().toISOString().split("T")[0];
  const requiredSlots=getRequiredSlots();
  let availableCount=0;

  for(let i=1;i<=142;i++){
    const card=document.querySelector(`.seat-card:nth-child(${i})`);
    const data=seatDataCache["seat_"+i];
    let isAvailable=true;

    ["s1","s2","s3","s4"].forEach(slot=>{
      const dot=document.querySelector(`.dot[data-seat="${i}"][data-slot="${slot}"]`);
      dot.classList.remove("green","grey","orange");
      if(!data||!data[slot]) dot.classList.add("green");
      else{
        const validTill=data[slot].validTill;
        if(validTill<today) dot.classList.add("green");
        else if(validTill===today) dot.classList.add("orange");
        else dot.classList.add("grey");
      }
      dot.style.display=requiredSlots.includes(slot)?"block":"none";
    });

    if(data){
      for(let slot of requiredSlots){
        if(data[slot] && data[slot].validTill>=today){
          isAvailable=false;
          break;
        }
      }
    }

    if(isAvailable){ card.classList.remove("disabled-seat"); availableCount++; }
    else card.classList.add("disabled-seat");
  }

  document.querySelector("#availableCount .value").innerText = availableCount;
}

async function initialize(){
  showLoader();
  createSeats();
  await loadAllSeats();
  updateDashboard();
  hideLoader();
}

document.getElementById("planSelect").addEventListener("change",()=>{
  updateDashboard();
});

document.getElementById("logoutBtn").onclick=async()=>{
  await signOut(auth);
  window.location.href="index.html";
};

initialize();

</script>
</body>
</html>

